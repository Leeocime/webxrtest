<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR 互动场景 - 手柄移动+视角切换</title>
    <!-- 引入 A-Frame 核心库 -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <!-- 引入额外控制组件（优化移动/手柄） -->
    <script src="https://unpkg.com/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>

    <!-- 自定义视角切换组件 -->
    <script>
        AFRAME.registerComponent('view-switcher', {
            schema: {
                currentView: { type: 'number', default: 0 },
                // 预设视角：[位置, 旋转]
                views: {
                    type: 'array',
                    default: [
                        [0, 1.6, 0, 0, 0, 0],       // 视角1：第一人称（初始）
                        [0, 8, -10, 60, 0, 0],      // 视角2：高空俯瞰
                        [2, 1.6, -3, 0, -30, 0]     // 视角3：聚焦立方体
                    ]
                }
            },
            init: function () {
                const el = this.el;
                const data = this.data;

                // 监听手柄 A/X 按钮（通用 VR 交互按钮）
                el.addEventListener('xbuttondown', () => this.switchView());
                el.addEventListener('abuttondown', () => this.switchView());
                
                // 键盘快捷键（调试用：按空格切换视角）
                document.addEventListener('keydown', (e) => {
                    if (e.code === 'Space') this.switchView();
                });
            },
            switchView: function () {
                const data = this.data;
                // 切换视角索引
                data.currentView = (data.currentView + 1) % data.views.length;
                const target = data.views[data.currentView];
                
                // 平滑过渡到目标视角
                this.el.setAttribute('animation', {
                    property: 'position',
                    to: `${target[0]} ${target[1]} ${target[2]}`,
                    dur: 800,
                    easing: 'easeOutCubic'
                });
                this.el.setAttribute('animation__rotation', {
                    property: 'rotation',
                    to: `${target[3]} ${target[4]} ${target[5]}`,
                    dur: 800,
                    easing: 'easeOutCubic'
                });

                // 视角切换提示（VR 中可见）
                const ui = document.querySelector('#viewHint');
                ui.setAttribute('text', 'value', `当前视角：${data.currentView + 1} / ${data.views.length}`);
                ui.setAttribute('animation__fade', {
                    property: 'opacity',
                    from: 1,
                    to: 0,
                    dur: 2000,
                    startEvents: 'animationstart'
                });
            }
        });

        // 自定义物体交互组件（激光点击反馈）
        AFRAME.registerComponent('interactive-object', {
            init: function () {
                const el = this.el;
                // 激光点击事件
                el.addEventListener('click', () => {
                    // 随机颜色
                    const color = `#${Math.floor(Math.random() * 16777215).toString(16)}`;
                    // 颜色切换动画
                    el.setAttribute('animation__color', {
                        property: 'material.color',
                        to: color,
                        dur: 300
                    });
                    // 缩放反馈动画
                    el.setAttribute('animation__scale', {
                        property: 'scale',
                        from: '1 1 1',
                        to: '1.2 1.2 1.2',
                        dur: 200,
                        dir: 'alternate'
                    });
                });
            }
        });
    </script>
</head>
<body>
    <!-- VR 场景容器 -->
    <a-scene 
        vr-mode-ui="enabled: true; enterVRButton: #enterVRBtn"
        renderer="antialias: true; physicallyCorrectLights: true"
        shadow="type: pcfsoft">

        <!-- 1. 环境元素 -->
        <!-- 天空盒（渐变天空） -->
        <a-sky color="#1a2b3c" gradient="top: #3a4b5c; bottom: #1a2b3c"></a-sky>
        <!-- 地面（带阴影接收） -->
        <a-plane 
            position="0 0 0" 
            rotation="-90 0 0" 
            width="50" 
            height="50" 
            color="#2d3e4f"
            shadow="receive: true"></a-plane>
        <!-- 墙壁（边界） -->
        <a-box position="0 1 -25" scale="50 2 1" color="#2d3e4f" shadow="receive: true"></a-box>
        <a-box position="25 1 0" scale="1 2 50" color="#2d3e4f" shadow="receive: true"></a-box>
        <a-box position="-25 1 0" scale="1 2 50" color="#2d3e4f" shadow="receive: true"></a-box>

        <!-- 2. 灯光系统 -->
        <a-ambient-light intensity="0.4"></a-ambient-light>
        <a-directional-light 
            position="10 20 10" 
            intensity="1" 
            castShadow="true"
            shadow-map-width="2048"
            shadow-map-height="2048"
            shadow-camera-left="-20"
            shadow-camera-right="20"
            shadow-camera-top="20"
            shadow-camera-bottom="-20"></a-directional-light>

        <!-- 3. 可交互物体 -->
        <!-- 主立方体（带交互反馈） -->
        <a-box 
            position="-2 1.5 -5" 
            rotation="0 45 0" 
            color="#4CC3D9"
            shadow="cast: true; receive: true"
            interactive-object></a-box>
        <!-- 球体 -->
        <a-sphere 
            position="3 2 -6" 
            radius="1" 
            color="#EF2D5E"
            shadow="cast: true; receive: true"
            interactive-object></a-sphere>
        <!-- 圆柱体 -->
        <a-cylinder 
            position="0 1 -8" 
            radius="0.8" 
            height="2" 
            color="#FFC107"
            shadow="cast: true; receive: true"
            interactive-object></a-cylinder>

        <!-- 4. 视角切换提示UI（VR中悬浮显示） -->
        <a-entity 
            id="viewHint"
            position="0 1.8 -1.5"
            scale="0.8 0.8 0.8"
            text="value: 按手柄A/X键切换视角 | 按空格键调试; align: center; color: #fff; font-size: 30;"
            opacity="1"></a-entity>

        <!-- 5. 相机+控制器（核心交互） -->
        <a-entity 
            camera 
            look-controls="pointerLockEnabled: true"
            movement-controls="
                enabled: true; 
                scheme: leapmotion; 
                fly: false; 
                speed: 1.5;
                acceleration: 50;
                deceleration: 50;"
            view-switcher
            position="0 1.6 0">

            <!-- 右手柄：激光+模型 -->
            <a-entity 
                laser-controls="hand: right; color: #4CC3D9"
                raycaster="objects: [interactive-object]"
                oculus-touch-controls="hand: right; model: true"></a-entity>
            
            <!-- 左手柄：激光+模型（控制移动） -->
            <a-entity 
                laser-controls="hand: left; color: #FFC107"
                oculus-touch-controls="hand: left; model: true"></a-entity>
        </a-entity>

        <!-- 6. 自定义进入VR按钮（可选） -->
        <a-entity 
            id="enterVRBtn"
            position="0 1.6 -3"
            geometry="primitive: plane; width: 2; height: 0.8"
            material="color: #4CC3D9; opacity: 0.9"
            text="value: 进入VR | Enter VR; align: center; color: #fff; font-size: 40;"
            cursor="rayOrigin: mouse"></a-entity>
    </a-scene>
</body>
</html>